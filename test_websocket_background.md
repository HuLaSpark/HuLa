# WebSocket 后台断连修复测试指南

## 修复内容概述

### 1. 问题分析

- **心跳机制在后台被暂停**：移动端和桌面端在后台时，定时器可能被系统暂停
- **缺少应用生命周期监听**：没有监听应用从后台恢复到前台的事件
- **重连逻辑不够智能**：没有在应用恢复时主动检查连接状态
- **心跳超时检测过于严格**：可能导致误判连接断开

### 2. 修复方案

#### Rust 后端修复

1. **增强 WebSocket 客户端状态跟踪**
   - 添加应用后台状态跟踪 (`is_app_in_background`)
   - 添加前台恢复时间记录 (`last_foreground_time`)
   - 添加后台心跳失败计数器 (`background_heartbeat_failures`)

2. **优化心跳机制**
   - 后台模式下使用更宽松的超时时间（2分钟 vs 15秒）
   - 后台模式下允许更多次心跳失败（5次 vs 3次）
   - 区分前台和后台的心跳失败计数

3. **智能重连机制**
   - 应用从后台恢复时自动检查连接状态
   - 如果60秒内无心跳则强制重连
   - 发送测试心跳验证连接有效性

4. **新增 Tauri 命令**
   - `ws_set_app_background_state`: 设置应用后台状态
   - `ws_get_app_background_state`: 获取应用后台状态

#### 前端修复

1. **增强 Rust WebSocket 客户端**
   - 添加 `setAppBackgroundState` 和 `getAppBackgroundState` 方法
   - 集成应用生命周期状态管理

2. **改进网络重连 Hook**
   - 在 `visibilitychange` 事件中通知 WebSocket 状态变化
   - 应用恢复前台时通知 WebSocket
   - 应用进入后台时通知 WebSocket

## 测试步骤

### 1. 编译和运行

```bash
cd /Users/qiuliang/company/luohuo-app/HuLa
pnpm run build
pnpm run tauri dev
```

### 2. 基础功能测试

1. **连接测试**
   - 启动应用，确认 WebSocket 连接成功
   - 检查控制台日志，确认看到 "✅ WebSocket 连接初始化成功"

2. **心跳测试**
   - 观察控制台日志，确认定期发送心跳 "💓 发送心跳"
   - 确认收到心跳响应 "💓 收到心跳响应"

### 3. 后台断连修复测试

#### 桌面端测试

1. **短时间后台测试**
   - 将应用最小化或切换到其他应用 30 秒
   - 恢复应用，检查 WebSocket 连接状态
   - 预期：连接保持正常，无重连

2. **长时间后台测试**
   - 将应用最小化或切换到其他应用 5-10 分钟
   - 恢复应用，观察控制台日志
   - 预期：看到 "📱 应用从后台恢复到前台" 和连接检查日志

3. **网络中断恢复测试**
   - 将应用置于后台
   - 断开网络连接 2 分钟
   - 恢复网络连接
   - 将应用恢复到前台
   - 预期：自动重连成功

#### 移动端测试（如果支持）

1. **应用切换测试**
   - 切换到其他应用 2-3 分钟
   - 返回应用
   - 预期：自动检查并恢复连接

2. **锁屏测试**
   - 锁定设备屏幕 5 分钟
   - 解锁并打开应用
   - 预期：连接自动恢复

### 4. 日志验证

查看以下关键日志消息：

#### 应用状态变化

```
📱 应用进入后台模式
📱 应用从后台恢复到前台
🔍 检查连接状态: CONNECTED, 最后心跳: XXXms前
```

#### 心跳机制

```
⚠️ 心跳超时 (后台模式, 连续失败: X, XXXms前收到最后心跳)
💓 发送测试心跳
💔 连接可能已断开，强制重连
```

#### 重连机制

```
🔄 连接已断开，尝试重新连接
✅ WebSocket 重连成功
```

### 5. 性能验证

1. **内存使用**：确认修复后内存使用没有显著增加
2. **CPU 使用**：确认后台模式下 CPU 使用率较低
3. **电池消耗**：移动端确认电池消耗没有显著增加

## 预期改进效果

1. **后台断连问题解决**：应用长时间后台后不再出现 WebSocket 断连
2. **智能重连**：应用恢复时自动检查并恢复连接
3. **更好的用户体验**：减少手动重连的需要
4. **资源优化**：后台模式下更节省资源

## 故障排除

如果测试中发现问题：

1. **检查日志**：查看 Rust 日志和前端控制台日志
2. **验证命令注册**：确认新的 Tauri 命令已正确注册
3. **网络环境**：确认网络环境稳定
4. **版本兼容性**：确认 Tauri 和相关依赖版本兼容

## 回滚方案

如果修复导致新问题，可以：

1. 临时禁用 Rust WebSocket 实现，使用原始 Worker 实现
2. 在 `webSocketAdapter.ts` 中设置 `USE_RUST_WEBSOCKET = false`
