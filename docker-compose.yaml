version: '3.7'
services:
  tauri:
    image: ubuntu:22.04
    volumes:
      - .:/app
      # åªæŒ‚è½½æž„å»ºäº§ç‰©ç›®å½•
      - ./src-tauri/target/release:/app/src-tauri/target/release
    environment:
      - RUST_BACKTRACE=1
      - CARGO_HOME=/root/.cargo
      - RUSTUP_HOME=/root/.rustup
      - DEBIAN_FRONTEND=noninteractive
    command:
      - 'bash'
      - '-c'
      - |
        cd /app
        apt-get update
        apt-get install -y curl git build-essential libwebkit2gtk-4.1-dev librsvg2-dev patchelf libudev-dev \
            libasound2-dev pkg-config libgtk-3-dev libayatana-appindicator3-dev

        # å®‰è£… Node.js 22
        curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
        apt-get install -y nodejs
        npm install -g npm@latest

        # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ pnpm
        npm install -g pnpm@9
        pnpm --version

        # å®‰è£… Rust
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$CARGO_HOME/env"

        # é…ç½®é•œåƒæº
        pnpm config set registry https://repo.huaweicloud.com/repository/npm/
        rustup default stable
        mkdir -p ~/.cargo
        echo '[source.crates-io]
        replace-with = "rsproxy-sparse"
        [source.rsproxy]
        registry = "https://rsproxy.cn/crates.io-index"
        [source.rsproxy-sparse]
        registry = "sparse+https://rsproxy.cn/index/"
        [registries.rsproxy]
        index = "https://rsproxy.cn/crates.io-index"' > ~/.cargo/config.toml

        # æž„å»ºé¡¹ç›®
        cd /app
        echo "ðŸ“¦ Installing dependencies..."
        rm -rf node_modules pnpm-lock.yaml
        pnpm install

        echo "ðŸ”¨ Building Vite project..."
        pnpm build || exit 1

        echo "âœ¨ Starting Tauri build..."
        pnpm tauri build || exit 1
        echo "âœ… Tauri build completed. Check src-tauri/target/release for the output."
